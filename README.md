# distri

distri is a music management suite I am making to handle all my music. It routes information from a folder of source audio/images/data into two directories: one to be served as a static website, and the other to be an object storage bucket.

It expects the current working directory to contain the following four folders:

- `audio.astronomy487.com`, stores the contents to be synced to the R2 bucket served at audio.astronomy487.com
- `music.astronomy487.com`, stores the contents to be served at the static site music.astronomy487.com
- `private`, stores private intermediate files
- `source`, stores the original copies of all files

In the source folder, it expects

- `source/webassets`, files to be included with the static website build
- `source/audio`, flacs of every song (albums in folders)
- `source/image`, 3000x3000 PNGs of album/single artwork
- `source/discog.json`, a JSON of all music data, as described in [[discog format.md]]

It can perform the following functions:

- `distri validate` Validate discog.json without encoding anything.
- `distri encode` Encode audio for audio.astronomy487.com.
- `distri build` Build static website for music.astronomy487.com.
- `distri clean` Clean out non-source files from the directory. Re-encoding everything will take a while, so be careful!
- `distri publish` Publish content to Cloudflare R2 bucket and pages workers. (Will run encode and build beforehand.)

It depends on tools rclone.exe, ffmpeg.exe, and wrangler.cmd to be installed and available on your path. rclone and wrangler should already be configured with your credentials.

I write "you" as if anybody other than me is expected to execute this program

## wishlist before it's ready for actual use

- statically generate index.html (goes with the above)
- make sure synced lyric data actually makes it to USLT in mp3s
- anything still marked TODO
- anything still marked WISHLIST

### changelog

- v0.4.0
	- moved link page generation to its own page, using my own xml.rs instead of maud
	- moved home page generation to its own page, using my own xml.rs instead of maud
	- moved lyric tsvs from within the json to its own source directory
	- web assets are now generated by distri itself (no source/webassets folder)
	- xml can do escape sequences now
	- runtime css compression, manual js compression (it's fine)
	- april 1 css nuke easter egg
	- remixes must provide a genre (no longer implicit Electronic)
- v0.3.0
	- stronger lints, better printing
	- albums now have genres
	- public filenames no longer use slugs - they are the actual title! wow
	- made `released`, `palette`, `artwork` are no longer optional on Songs. they inherit these properties from parent albums when absent in the json
	- made it so the slug for a song/album is only ever computed once. this took so much refactoring
- v0.2.0
	- move authorization checks for wrangler and rclone to `distri_publish()`
	- hasten check that ffmpeg, wrangler, and rclone and installed by just checking path environment variable
	- made album palettes mandatory
	- encoding now includes genre as "Electronic", for both mp3 and flac
	- further validate URLs, UPCs, ISRCs, and lyrics. normalize urls for astronomy487.com to end with slashes
	- decouple `parent_album: Option<&Album>` from `Titlable::Song`; now we check `song.parent_album_indices` to see if a parent album exists, and `all_albums: &[Album]` gets passed around everywhere
	- also re-encode the PNGs i distribute (because metadata concerns; the `image` crate wipes metadata on writes)
	- Codec enum becomes AudioCodec, introduce ImageCodec and TextCodec (do text file formats really count as codecs? whatever)
- v0.1.0
	- first fully working version, start of changelog
	- i'm just relieved i got wrangler and rclone to do my bidding